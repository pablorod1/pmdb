---
import Layout from '../layouts/Layout.astro';
import ChevronRight from '../icons/ChevronRight.astro';
import ChevronLeft from '../icons/ChevronLeft.astro';

import SectionContainer from '../components/SectionContainer.astro';
import ProgressSpinner from '../components/ProgressSpinner.astro';

import { getPopularSeries, getPopularMovies, getTrendingMovies } from '../lib/tmdb';

const popularMovies = await getPopularMovies();
const trendingMovies = await getTrendingMovies();
const carouselMovies = popularMovies.slice(0, 5);

const popularSeries = await getPopularSeries();

console.log(popularSeries);

// format vote_average to %
function formatVoteAverage(vote_average: number) {
	vote_average = vote_average * 10;
	return Math.round(vote_average);
}
---

<Layout title="Welcome to Astro.">
	<main>
		<SectionContainer id="header" class="pb-10">
			<div class="single-glide relative pb-20">
				<div class="glide__track mx-12" data-glide-el="track">
					<ul class="glide__slides">
						{
							carouselMovies.map((movie: any) => {
								return (
									<li class="glide__slide ">
										<img class="w-full" src={`https://image.tmdb.org/t/p/original${movie.backdrop_path}`} alt="" />
									</li>
								)
							})
						}
					</ul>
				</div>
		
				<div class="glide__arrows" data-glide-el="controls">
					<button class="glide__arrow glide__arrow--left " data-glide-dir="<" style="border: 0;"><ChevronLeft class="size-14"/></button>
					<button class="glide__arrow glide__arrow--right " data-glide-dir=">" style="border: 0;"><ChevronRight class="size-14"/></button>
				</div>
		
				<div class="glide__bullets" data-glide-el="controls[nav]">
					{
						carouselMovies.map((movie: any, index: number) => (
							<button class="glide__bullet" data-glide-dir={`=${index}`}></button>
						))
					}
				</div>
			</div>
		</SectionContainer>

		<SectionContainer id="trending-movies">
			<div class="flex flex-col px-24">
				<h1 class="flex text-white font-bold text-3xl">Tendencia</h1>
				<div class="multiple-glide relative py-12">
					<div class="glide__track mx-12" data-glide-el="track">
						<ul class="glide__slides">
							{
							trendingMovies.map((movie: any, index: number) => (
									<li class="glide__slide relative flex items-center justify-center">
										<img class="w-full" src={`https://image.tmdb.org/t/p/original${movie.poster_path}`} loading="lazy" />
										<ProgressSpinner id={`movie-${index}`} percent={formatVoteAverage(movie.vote_average)}/>
									</li>
								))
							}
						</ul>
					</div>
				</div>
			</div>
		</SectionContainer>

		<SectionContainer id="popular-movies">
			<div class="flex flex-col px-24">
				<h1 class="flex text-white font-bold text-3xl">Pel√≠culas Populares</h1>
				<div class="multiple-glide relative py-12">
					<div class="glide__track mx-12" data-glide-el="track">
						<ul class="glide__slides">
							{
							popularMovies.map((movie: any, index: number) => (
									<li class="glide__slide relative flex items-center justify-center">
										<img class="w-full" src={`https://image.tmdb.org/t/p/original${movie.poster_path}`} loading="lazy" />
										<ProgressSpinner id={`movie-${index}`} percent={formatVoteAverage(movie.vote_average)}/>
									</li>
								))
							}
						</ul>
					</div>
				</div>
			</div>
		</SectionContainer>

		<SectionContainer id="popular-series">
			<div class="flex flex-col px-24">
				<h1 class="text-white font-bold text-3xl">Series Populares</h1>
				<div class="multiple-glide py-12">
					<div class="glide__track mx-12" data-glide-el="track">
						<ul class="glide__slides">
							{
							popularSeries.map((serie: any, index: number) => (
										<li class="glide__slide relative flex items-center justify-center">
											<img class="w-full" src={`https://image.tmdb.org/t/p/original${serie.poster_path}`} loading="lazy" />
											<ProgressSpinner id={`serie-${index}`} percent={formatVoteAverage(serie.vote_average)}/>
										</li>
								))
							}
						</ul>
					</div>
				</div>
			</div>
		</SectionContainer>
	</main>
</Layout>

<style is:global>
	/* Single Glide Carousel */
	.single-glide .glide__track{
		overflow: visible !important;
	}
	.single-glide .glide__arrows{
		opacity: 0;
		transition: opacity 0.3s;
	}
	.single-glide:hover .glide__arrows{
		opacity: 1;
	}
	.single-glide .glide__slide:not(.glide__slide--active){
		transition: opacity 0.3s ease;
	}
	.single-glide .glide__slide{
		border-radius: .5rem;
		overflow: hidden;
	}
	.single-glide .glide__slide img{
		width: 100%;
		object-fit: cover;
		max-height: 540px;
		height: 100%;
	}
	.single-glide .glide__slide--active{	
		border: 2px solid transparent;
		box-shadow: rgba(0, 0, 0, 0.8) 0px 26px 30px , rgba(0, 0, 0,1) 0px 16px 10px -10px;
		transition: border 0.2s ease, opacity 0.2s ease, box-shadow 0.3s ease;
	}
	.single-glide .glide__slide--active:hover{
		border: 2px solid white;
	}
	.single-glide .glide__arrow--left{
		left: -.5rem !important;
	}
	.single-glide .glide__arrow--right{
		right: -1rem !important;
	}
	.single-glide .glide__slide:not(.glide__slide--active){
		opacity: 0.5;
	}
	.single-glide .glide__slides{
		overflow: visible !important;
	}

	/* Multiple Glide Carousel */
	.multiple-glide .glide__track{
		overflow: visible !important;
	}
	.multiple-glide .glide__slide{
		border-radius: .5rem;
		overflow: hidden;
	}
	.multiple-glide .glide__slide img{
		width: 100%;
		object-fit: cover;
	}
	.multiple-glide .glide__slide{
		position: relative;
		transition: opacity 0.3s ease, transform 0.3s ease;
	}
	.multiple-glide .glide__slide:not(.glide__slide--active){
		opacity: 0.5;
		transform: scale(1);
	}
	.multiple-glide .glide__slide--active{
		opacity: 1;
		transform: scale(1.1);
	}
	.multiple-glide .glide__slides{
		overflow: visible !important;
	}
	.multiple-glide .glide__arrow{
		position: absolute;
		box-shadow: none;
	}
	.multiple-glide .glide__slide--active:hover .progress-spinner-container{
		opacity: 1;
	}
	.multiple-glide .glide__slide--active:hover img{
		filter: brightness(0.8) blur(1px);
	}
	.multiple-glide .glide__slide:not(.glide__slide--active) .progress-spinner-container{
		opacity: 1;
		transform: scale(0.6) translate(-60%, 120%);
	}

</style>

<script>
  import "../lib/carousel.js";
</script>

